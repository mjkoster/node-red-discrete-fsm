<script type="text/html" data-template-name="state">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label>Initialize FSM to this State (check exactly one state node)</label>
    <input type="checkbox" id="node-input-isinitialstate" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-isinitialstate">isInitialState</label>
  </div>

  <label>Output Vector</label>
  <div class="form-row node-input-outputdata-container-row">
    <ol id="node-input-outputdata-container"></ol>
  </div>

  <label>Transitions</label>
  <div class="form-row node-input-transitiondata-container-row">
    <ol id="node-input-transitiondata-container"></ol>
  </div>
</script>

<script type="text/html" data-help-name="output">
  <p>holds a FSM state, sets the output vector, and generates transitions in response to conditions</p>
</script>

<script type="text/javascript">
  RED.nodes.registerType('state',{
    category: 'DiscreteFSM',
    color: '#3FADB5',
    defaults: {
      name: {value: ""},
      isinitialstate: {value:false},
      outputvector: {value: {}},
      transitions: {value: {}}
    },
    inputs:1,
    outputs:1,
    icon: "font-awesome/fa-cogs",
    label: function() {
      return this.name||"state";
    },
    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {

      var outputdata = $('#node-input-outputdata-container').css('min-height','120px').css('min-width','450px');
      outputdata.editableList({
        addItem: function(container,index,item) {

          container.css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          });
          var row = $('<div/>').appendTo(container);

          var outputName = $('<input/>',{class:"node-input-output-name",type:"text"})
            .css("width","25%")
            .appendTo(row)
            .typedInput({types:['str']});

          $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('=')
            .appendTo(row);

          var outputValue = $('<input/>',{class:"node-input-output-value",type:"text"})
            .css("width","calc(75% - 30px)")
            .appendTo(row)
            .typedInput({types:['str','num','bool']});
          
          outputName.typedInput('value',item.name || "");
          outputValue.typedInput('value',item.value || null);
        },
        removable: true,
        sortable: true
      });
      for (var output in this.outputVector) {
        outputdata.editableList('addItem', name:output, value:this.outputvector[output]);

      var transitiondata = $('#node-input-transitiondata-container').css('min-height','120px').css('min-width','450px');
      transitiondata.editableList({
        addItem: function(container,index,item) {

          container.css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          });
          var row = $('<div/>').appendTo(container);

          $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('on condition')
            .appendTo(row);

          var conditionName = $('<input/>',{class:"node-input-condition-name",type:"text"})
            .css("width","50%")
            .appendTo(row)
            .typedInput({types:['str']});

          $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('transition to')
            .appendTo(row);

          var stateName = $('<input/>',{class:"node-input-state-name",type:"text"})
            .css("width","calc(50% - 30px)")
            .appendTo(row)
            .typedInput({types:['str']});

          conditionName.typedInput('value',item.condition || "");
          stateName.typedInput('value',item.state || "");
        },
        removable: true,
        sortable: true
      });
      for (var condition in this.transitions) {
        transitiondata.editableList('addItem', {condition:condition, state:this.transitions[condition]} );
      }
    },

    oneditsave: function() {

      var items = $("#node-input-outputdata-container").editableList('items');

      items.each(function(i) {
        var item = $(this);
        var outputName = item.find(".node-input-output-name").typedInput('value');
        var outputValue = item.find(".node-input-output-value").typedInput('value');
        this.outputvector[outputName] = outputValue;
      });

      var items = $("#node-input-transitiondata-container").editableList('items');

      items.each(function(i) {
        var item = $(this);
        var conditionName = item.find(".node-input-condition-name").typedInput('value');
        var transitionName = item.find(".node-input-transition-name").typedInput('value');
        this.transitions[conditionName] = transitionName;
      });
    }
  });
</script>

